receivers:
  # Docker 컨테이너 로그 수집
  filelog:
    include:
      - /var/lib/docker/containers/*/*.log
      - /var/log/app/*.log
    start_at: end
    operators:
      - type: json_parser
        id: docker-parser
      - type: move
        from: attributes.log
        to: body
      - type: move
        from: attributes.stream
        to: attributes["log.iostream"]
      - type: move
        from: attributes.time
        to: attributes["log.time"]

  # OTLP 프로토콜 수신 (애플리케이션에서 직접 전송)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Docker 컨테이너 메트릭 수집
  docker_stats:
    endpoint: unix:///var/run/docker.sock
    collection_interval: 30s

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024

  resource:
    attributes:
      - key: deployment.environment
        value: docker
        action: upsert

  resourcedetection:
    detectors: [env, system, docker]
    timeout: 5s

exporters:
  # Elasticsearch로 직접 전송
  elasticsearch:
    endpoints:
      - http://elasticsearch:9200
    logs_index: otel-logs
    traces_index: otel-traces
    metrics_index: otel-metrics

  # 디버깅용 콘솔 출력
  debug:
    verbosity: basic

extensions:
  health_check:
    endpoint: 0.0.0.0:13133

service:
  extensions: [health_check]
  pipelines:
    logs:
      receivers: [filelog, otlp]
      processors: [batch, resource, resourcedetection]
      exporters: [elasticsearch]
    traces:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [elasticsearch]
    metrics:
      receivers: [otlp, docker_stats]
      processors: [batch, resource]
      exporters: [elasticsearch]
